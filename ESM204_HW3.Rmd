---
title: "ESM 204 Assignment 3"
author: "Julia Wilson"
output: html_document
date: '2022-05-06'
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

library(tidyverse)
library(here)
library(janitor)
library(thematic)
library(ggplot2)
library(equatiomatic)
```


## Overview

```{r, include = FALSE}
# Read in data

electricity <- read_csv(here("data", "hw3_data.csv")) %>% 
  clean_names() %>% 
  select(-x1)

```

The Biden Administration’s “interim” value is $51 per metric ton of CO2. The electricity sector is the second largest source of greenhouse gas emissions in the U.S. (after transportation). In this analysis, we will consider the distributional consequences of imposing a household electricity tax based on the SCC to address the climate change problem.

## Analysis

The data includes the following: 
- Consumers can be separated into two income groups: “high” and “low.” 
- Price (in $) and quantity (in kWh) estimates of demand per month for the two groups. 

The analysis will show linear regressions (with an intercept) to estimate the demand curves for “high” and “low” income consumers under the following scenarios: 

-  Initially, there is no tax on electricity consumption.
- The current electricity price (without any taxes) is $.10 per kWh.
- The marginal cost of producing a kWh of electricity is linear and has a price-intercept of 0.

### **1. Marginal External Cost of electricity**

Assuming one kWh of electricity emits 0.85 pounds of CO2 and the interim SCC is $51/ton, we can then calculate the MEC per kWh. 

```{r, include = FALSE}

# Create a longer data set switching income from a column to a variable

electricity_long <- electricity %>% 
  pivot_longer(cols = c(q_low_kwh, q_high_kwh),
               names_to = 'income_level',
               values_to = 'kwh') %>%
  mutate(income_level = case_when(income_level == 'q_low_kwh' ~ 'low',
                                  income_level == 'q_high_kwh' ~ 'high'))

# Run a calculation to get the MEC 

# Set up the interim price at $51/ton
interim_price_ton <- 51

# Convert price per ton to price/lb 
interim_price_lb <- interim_price_ton/2205

# Multiply the interim price by 0.85 to get MEC/kWh 
interim_price_kWh <- interim_price_lb * 0.85

```

The marginal external cost per kWh of electricity is $`r round(interim_price_kWh, 3)`.

### **2. Aggregations**

**Aggregate Demand Curve** 
To find the aggregate demand curve, we will first find the high and low income demand curves. 

**Low Income Demand Curve:**

*P = 23.37 - 0.0001102Q*
```{r, include = FALSE}
# lm estimates for both low and high incomes 
demand_low <- lm(price_cents ~ kwh, income_level == 'low',
                 data = electricity_long)
extract_eq(model = demand_low, use_coefs = TRUE, coef_digist = 8)

demand_low
```


**High Income Demand Curve:**

*P = 31.61 - 0.000052Q*
```{r, include = FALSE}
demand_high <- lm(price_cents ~ kwh, income_level == 'high',
                  data = electricity_long)
extract_eq(model = demand_high, use_coefs = TRUE, coef_digist = 5)

demand_high
```



```{r}
# Demand model from sample code

demand <- function(p, model){
  q <- (p - model$coefficients[[1]])/model$coefficients[[2]]
  q <- ifelse(q<0,0,q)
  return(q)
}
```


```{r}
# Aggregate demand from code sample 

demand_agg <- function(p){
  q <- demand(p, demand_low) + demand(p, demand_high)
  return(q)
}

# demand_agg(10) = 536,719.5
```

With the income-based demand curves, we can sum horizontally to find the **aggregate demand curve:** 29.78135 - 0.00004(Qagg)

```{r}
# Make a vector and extract the lm 
price = seq(0, 30, length.out = 100)

Qagg <- map(price, demand_agg) %>% 
  unlist()

agg_df<- tibble(Qagg = Qagg, price = price)

demand_agg_eq <- lm(price ~ Qagg, data = agg_df) 
```

```{r}
# Switch the equations above so Q is on one side and then add

agg_slope <- demand_agg_eq$coefficients[2]
agg_int <- demand_agg_eq$coefficients[1]

agg_slope
agg_int

# Aggregate demand function is P = 29.78135 - 0.00004(Qagg)

```


```{r, include = FALSE}

# [OLD CODE, CAN DELETE]

# Convert the equations so that Q is on one side and the sum

demand_low_flip <- lm(kwh ~ price_cents, income_level == 'low', data = electricity_long)

demand_high_flip <- lm(kwh ~ price_cents, income_level == 'high', data = electricity_long)

kwh_agg_int <- (demand_low_flip$coefficients[1]+demand_high_flip$coefficients[1])

kwh_agg_slope <- (demand_low_flip$coefficients[2] +
                    demand_high_flip$coefficients[2])

demand_agg_p <- function(price_cents){kwh_agg_int + kwh_agg_slope*(price_cents)}

demand_agg_int <- kwh_agg_int*-kwh_agg_slope
demand_agg_slope <- 1/kwh_agg_slope

# Aggregate demand function: P = 30.5 - 0.000039Q

demand_agg <- function(kwh){demand_agg_int + demand_agg_slope *kwh}
  
```


**Supply Curve**

The current price is $0.10/kWh and the MC for electricity is linear with a 0 intercept. 

```{r, include = FALSE}
kwh_agg <- demand_agg_p(10)

# 536,719.5 kWh at $0.10

supply_slope <- 10/kwh_agg
# 0.000019
```

The supply curve will pass through the agg demand curve at $0.10/kwh. We can then infer the supply curve equation will be: 

*P = 0.0000192Q*

#### Visualize the data

```{r}
ggplot(agg_df, aes(Qagg, price)) +
  geom_line(color = "goldenrod3") +
  annotate("text", x = 400000, y = 17, 
           label = "Demand (Agg)", angle = -30) +
  geom_abline(color = "firebrick4",
              intercept = demand_high$coefficients[1],
              slope= demand_high$coefficients[2]) +
  annotate("text", x = 300000, y = 15, 
           label = "High-Income Demand", angle = -38) +
  geom_abline(color = "steelblue4",
              intercept = demand_low$coefficients[1],
              slope= demand_low$coefficients[2]) +
  annotate("text", x = 150000, y = 9, 
           label = "Low-Income Demand", angle = -60) +
  geom_abline(color = "darkolivegreen",
              intercept = 0,
              slope= supply_slope) +
  annotate("text", x = 300000, y = 7, 
           label = "MPC", angle = 17) +
  labs(x = "Electricity Consumed (kWh)",
       y = "Price (cents/kWh)") +
  theme_minimal()
```

#### **Figure 1: Market for Electricity**



We can then calculate consumer and producer surplus and environmental cost. We will be cautious of converting from cents to dollars. 

```{r}
# Consumer Surplus 

# Converting cents to dollars for the y-axis
cs <- 0.5*kwh_agg*(0.305-0.10)
cs
# $53,518.12

# Producer Surplus 

ps <- 0.5*kwh_agg*(.10)
# $26,106.39

# Environmental Cost 
env_cost <- interim_price_kWh*kwh_agg
# $10,264.96
```

- Consumer Benefit = $`r round(cs,0)`
- Producer Benefit = $`r round(ps,0)`
- Environmental Cost = $`r round(env_cost,0)`


### **3. Consumer Benefit**

**Low income consumers:** consumer benefit is found by taking the area under the low income demand curve but above the current price of electricity ($0.10/kWh). This area is a triangle with base 121545 and height 13.37. 

  0.5 * 13.37 cents/kWh * 121545 kWh = 812,528 cents 
  
  **benefit for low income consumers is $8,125.3.**

**High income consumers:**consumer benefit is found by taking the area under the high income demand curve but above the current price of electricity ($0.10/kWh). This area is a triangle with base 415577 and height 21.61.

  0.5 * 21.61 cents/kWh * 415577 kWh = 4,490,309.5 cents

  **benefit for high income consumers is $44,903.1.**
  
total consumer surplus = 8,125.3 + 44,903.1 = $53,028.4

total consumer surplus = (13.37 * 158,641.5) + ((31.61 - 23.37) * 0.5  * 158,641.5) + (0.5 * (525,641  - 158,641.5) * 13.37)
total consumer surplus = **$52,280.3 (CHECK THIS)**

(8,125.3/53,028.4)*100 = 15.3%
(44,903.1/53,028.4)*100 = 84.7%

**low income consumers receive 15.3% of the total benefit.**

**high income consumers receive 84.7% of the total benefit. **



### **4. Optimal Tax**

### **5. Redistribution**

### **6. Solar PV**